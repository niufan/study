-- 表空间

---- 创建表空间（TS_TEST）并指定多个文件
CREATE TABLESPACE ABS_TB_BAH 
DATAFILE 
'E:\app\orcl\oradata\orcl\ABS_TB_BAH_1.dbf' SIZE 1G AUTOEXTEND ON NEXT 200M MAXSIZE UNLIMITED,
'E:\app\orcl\oradata\orcl\ABS_TB_BAH_2.dbf' SIZE 1G AUTOEXTEND ON NEXT 200M MAXSIZE UNLIMITED,
'E:\app\orcl\oradata\orcl\ABS_TB_BAH_3.dbf' SIZE 1G AUTOEXTEND ON NEXT 200M MAXSIZE UNLIMITED
;

---- 为表空间添加数据文件（一个数据文件最大32G后就不会自动扩展了）
ALTER TABLESPACE ABS_TB_BAH ADD DATAFILE '/oracle/app/oracle/xydb2/abs_tb_bah_2.dbf' SIZE 1G AUTOEXTEND ON NEXT 200M MAXSIZE UNLIMITED;

---- 删除表空间（TS_TEST）及其文件
DROP TABLESPACE TS_TEST INCLUDING CONTENTS AND DATAFILES CASCADE CONSTRAINT;

---- 查询表空间及其大小
SELECT T.TABLESPACE_NAME, ROUND(SUM(BYTES / (1024 * 1024)), 0) TS_SIZE FROM DBA_TABLESPACES T, DBA_DATA_FILES D WHERE T.TABLESPACE_NAME = D.TABLESPACE_NAME GROUP BY T.TABLESPACE_NAME;
---- 查询表空间及其文件、大小
SELECT TABLESPACE_NAME, FILE_ID, FILE_NAME, ROUND(BYTES / (1024 * 1024), 0) TOTAL_SPACE FROM DBA_DATA_FILES ORDER BY TABLESPACE_NAME;

-- 用户

---- 创建用户（C##U_TEST，Oracle 12 创建用户时，需要添加C##前缀）并指定默认表空间
CREATE USER C##U_TEST IDENTIFIED BY 123456 DEFAULT TABLESPACE TS_TEST;
---- 删除用户
DROP USER C##U_TEST CASCADE;


-- 授权

---- 授予用户登陆权限
GRANT RESOURCE, CONNECT TO C##U_TEST;
---- 授予用户创建序列的权限
GRANT CREATE ANY SEQUENCE TO C##U_TEST;
---- 授予用户创建视图的权限
GRANT CREATE VIEW TO C##U_TEST;
---- 授予用户创建触发器的权限
GRANT CREATE TRIGGER TO C##U_TEST;
---- 授予用户创建函数、存储过程的权限
GRANT CREATE ANY PROCEDURE TO C##U_TEST;
---- 授予用户DBA角色
GRANT DBA TO C##U_TEST;

-- 表，表分区
---- 创建表时指定表空间（TS_TEST），按每月一个分区，开始时间 2017-11-01之前的在一个分区，以后每月会自动创建一个分区
---- STORE IN(TS_TEST) 表示以后自动创建的分区，会建在TS_TEST表空间
---- 注意：使用 INTERVAL 自动创建分区的方式（按间隔自动创建），在数据导入导出时不能使用IMP/EXP，要使用IMPDP/EXPDP
CREATE TABLE "T_TEST"(
"ID" NUMBER(9, 0) CONSTRAINT PK_TEST_ID PRIMARY KEY,
"USERNAME" VARCHAR2(100BYTE) NOT NULL,
"NICKNAME" VARCHAR2(100BYTE) NOT NULL,
"DELETED" NUMBER(1,0) DEFAULT 0,
"UPDATE_TIME" TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
"CREATE_TIME" TIMESTAMP(6) DEFAULT SYSTIMESTAMP
) TABLESPACE TS_TEST
PARTITION BY RANGE (CREATE_TIME) INTERVAL (NUMTOYMINTERVAL(1, 'MONTH')) STORE IN(TS_TEST)
(PARTITION P_T_201710 VALUES LESS THAN (TO_DATE('2017-11-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')) TABLESPACE TS_TEST)
;
COMMENT ON TABLE "T_TEST" IS '测试表';
COMMENT ON COLUMN "T_TEST"."ID" IS 'ID';
COMMENT ON COLUMN "T_TEST"."USERNAME" IS '用户名';
COMMENT ON COLUMN "T_TEST"."NICKNAME" IS '昵称';
COMMENT ON COLUMN "T_TEST"."DELETED" IS '已删除，0：没删除，1：已删除';
COMMENT ON COLUMN "T_TEST"."CREATE_TIME" IS '创建时间';
COMMENT ON COLUMN "T_TEST"."UPDATE_TIME" IS '修改时间';

---- 子分区，删除的一个子分区，未删除的一个子分区
CREATE TABLE "T_TEST"(
"ID" NUMBER(9, 0) CONSTRAINT PK_TEST_ID PRIMARY KEY,
"USERNAME" VARCHAR2(100BYTE) NOT NULL,
"NICKNAME" VARCHAR2(100BYTE) NOT NULL,
"DELETED" NUMBER(1,0) DEFAULT 0,
"UPDATE_TIME" TIMESTAMP(6) DEFAULT SYSTIMESTAMP,
"CREATE_TIME" TIMESTAMP(6) DEFAULT SYSTIMESTAMP
) TABLESPACE TS_TEST
PARTITION BY RANGE (CREATE_TIME) INTERVAL (NUMTOYMINTERVAL(1, 'MONTH')) STORE IN(TS_TEST)
SUBPARTITION BY LIST(DELETED)
SUBPARTITION TEMPLATE (
SUBPARTITION P_T_201710_0 VALUES(0)
SUBPARTITION P_T_201710_1 VALUES(1)
(PARTITION P_T_201710 VALUES LESS THAN (TO_DATE('2017-11-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')) TABLESPACE TS_TEST)
;

---- 查询现有分区
SELECT * FROM USER_TAB_PARTITIONS;


---- 删除表
------ 通过此方式删除表，可以在用户回收站中查出已删除表的信息，可以回退
DROP TABLE T_TEST;
---- 查询用户回收站
SELECT * FROM USER_RECYCLEBIN;
---- 回退已删除的表
FLASHBACK TABLE T_TEST TO BEFORE DROP;
------ 添加PURGE删除，将直接删除，不会键入回收站，无法回退
DROP TABLE T_TEST PURGE;
------ 从回收站中清除表
PURGE TABLE T_TEST;
------ 清空用户回收站
PURGE RECYCLEBIN;
------ 清空所有用户的回收站
PURGE DBA_RECYCLEBIN;

-- EXP/IMP
---- 导入语句
imp sys/sys@orcl file=E:\FTP\139.224.206.25\数据库备份\abs_prod0201.dmp log=E:\TEMP\abs_prod0201.log fromuser=abs_prod touser=C##ABS_PROD_20180131


-- EXPDP/IMPDP

---- 导出语句
---- 注意指定版本 VERSION=11.2.0.4.0 此版本表示欲导入数据库的版本
EXPDP C##ABS_TEST_20180131/123456@ORCL tables=BIZ_ASSET_HISTORY DIRECTORY=DATA_BAK DUMPFILE=BIZ_ASSET_HISTORY.dmp LOGFILE=BIZ_ASSET_HISTORY.LOG VERSION=11.2.0.4.0

-- 导入语句
---- TRANSFORM=OID:N 指定Object ID重新生成，不会沿用原来的Object ID，REMAP_SCHEMA 指定schema转换，REMAP_TABLESPACE 执行表空间转换
IMPDP C##ABS_PROD_20180131/123456@ORCL DIRECTORY=DATA_BAK DUMPFILE=BIZ_ASSET_HISTORY.dmp TRANSFORM=OID:N REMAP_SCHEMA=C##ABS_TEST_20180131:C##ABS_PROD_20180131 REMAP_TABLESPACE=ABS_TB:ABS_PROD_TS_20180410,ABS_TB_BAH:ABS_PROD_TS_BAH_20180410 LOGFILE=BIZ_ASSET_HISTORY.LOG 
